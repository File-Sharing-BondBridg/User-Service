name: AI Code Review

on:
  pull_request:

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install tiny model deps
        run: |
          pip install --quiet torch==2.3.0 transformers==4.44.0

      - name: Generate diff
        run: |
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
          git diff ${{ github.base_ref }}... > diff.txt

      - name: Run AI review (StarCoder2-3B â€“ fits in RAM)
        env:
          HF_HUB_CACHE: /tmp/hf-cache
        run: |
          python - <<'PY'
          from transformers import AutoTokenizer, AutoModelForCausalLM
          import os, textwrap

          model_id = "bigcode/starcoder2-3b"
          tokenizer = AutoTokenizer.from_pretrained(model_id)
          model = AutoModelForCausalLM.from_pretrained(model_id, device_map="auto", torch_dtype="auto")

          diff = open("diff.txt").read()
          if not diff.strip():
              print("No changes to review.")
              open("ai-review.md", "w").write("No code changes in this PR.")
          else:
              prompt = f"""You are an expert Java reviewer. Provide concise, actionable feedback on:
              - Code quality & style
              - Security
              - Architecture
              - Performance

              ```diff
              {diff}